---
- name: Install jenv
  git: >
    repo=git://github.com/gcuisinier/jenv.git
    dest=~/.jenv
  tags: update

- name: Install Java versions
  mac_pkg: >
    pkg_name=com.oracle.jdk{{ item.major }}u{{ item.minor }} pkg_version=1.1
    url=http://download.oracle.com/otn-pub/java/jdk/{{ item.major }}u{{ item.minor }}-{{ item.patch }}/jdk-{{ item.major }}u{{ item.minor }}-macosx-x64.dmg
    curl_opts="-L --cookie oraclelicense=accept-securebackup-cookie"
    archive_type=dmg archive_path='JDK {{ item.major }} Update {{ item.minor }}.pkg'
  sudo: yes
  with_items: dotfiles.jvm.versions

- name: Download unlimited security policy
  command: >-
    curl -L
      --cookie oraclelicense=accept-securebackup-cookie
      -o /tmp/jce-policy-{{ item.major }}.zip
      {{ item.url }}
    creates=/tmp/jce-policy-{{ item.major }}.zip
  with_items: crypto_jars

- stat: path=/tmp/jce-policy-{{ item.major }}.zip
  register: stats
  with_items: crypto_jars

- name: Verify crypto JARs
  assert:
    that: item.item.shasum == item.stat.checksum
  with_items: stats.results

- name: Install unlimited security policy
  unarchive: >-
    src=/tmp/jce-policy-{{ item.major }}.zip
    dest=/Library/Java/JavaVirtualMachines/jdk1.{{ item.major }}.0_{{ item.minor }}.jdk/Contents/Home/jre/lib/security/
    creates=/Library/Java/JavaVirtualMachines/jdk1.{{ item.major }}.0_{{ item.minor }}.jdk/Contents/Home/jre/lib/security/README.txt
  sudo: yes
  with_items: dotfiles.jvm.versions

- name: Register all JVMs
  shell: 'jenv add {{ item }}/Contents/Home'
  with_fileglob:
    - /Library/Java/JavaVirtualMachines/*

- name: Set current JVM
  shell: 'jenv global {{ dotfiles.jvm.default_version }}'
  ignore_errors: yes
