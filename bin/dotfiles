#!/usr/bin/env ruby

require 'thor'

class Dotfiles < Thor
  VERSION = '0.0.1'
  DOTFILES_DIRECTORY = File.expand_path('~/.dotfiles')

  default_task :help

  desc 'update', 'Update all the files in dotfiles'
  method_option :submodules, :type => :boolean, :default => false, :banner => 'Update submodules as well'
  def update
    say 'Updating dotfiles...'
    in_dotfiles { |path| system 'git pull --rebase' }

    if options['submodules']
      say 'Updating submodules...'
      in_dotfiles do |path|
        system %[git submodule -q foreach 'git checkout -q master && git pull -q --rebase origin master' > /dev/null]
      end
    end
  end

  # desc 'cd', 'Take a look in dotfiles'
  # def cd
  #   exec 'cd', DOTFILES_DIRECTORY
  # end

  desc 'open', 'Open dotfiles'
  def open
    system 'open', DOTFILES_DIRECTORY
  end

  desc 'edit', 'Edit dotfiles in your editor'
  method_option :editor, :type => :string, :banner => 'Override $EDITOR'
  def edit
    system options[:editor] || ENV['EDITOR'], DOTFILES_DIRECTORY
  end

  desc 'version', 'Prints the version of dotfiles'
  map %w(-v --version) => :version
  def version
    puts VERSION
  end

  private

  def in_dotfiles(&block)
    begin
      Dir.chdir(DOTFILES_DIRECTORY, &block)
    rescue => e
      say 'Something went wrong!', :red
      say "#{e.class}: #{e.message}"
    end
  end
end

Dotfiles.start
